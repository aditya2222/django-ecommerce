<!DOCTYPE html>
<html>

<head>
    <title></title>
    {# jquery #}
    {# slim is missing ajax and we need ajax #}
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"
            integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ"
            crossorigin="anonymous"></script>
    {# bootstrap #}
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css"
          integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4"
          crossorigin="anonymous">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"
            integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm"
            crossorigin="anonymous"></script>
    {# font awesome #}

    <link rel="stylesheet" type="text/css"
          href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

    {# Jquery Confirm #}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.0/jquery-confirm.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.0/jquery-confirm.min.js"></script>

</head>

<body>
{% include "base/nav.html" with brand_name='eCommerce' %}
<div class="container">
    {% block content %} {% endblock content %}

</div>

<script type="text/javascript">
    $(document).ready(function () {
        {#Contact Form Handler#}

        var contactForm = $('.contact-form')
        var contactFormMethod = contactForm.attr("method")
        var contactFormEndpoint = contactForm.attr("action")

        contactForm.submit(function (event) {
            event.preventDefault()
            var contactFormData = contactForm.serialize()
            var thisForm = $(this)
            $.ajax({
                method: contactFormMethod,
                url: contactFormEndpoint,
                data: contactFormData,
                success: function (data) {
                    contactForm[0].reset()
                    $.alert({
                        title: 'Success!',
                        content: data.message   ,
                        theme: "modern"
                    })
                },
                error: function (error) {
                    console.log(error)
                    $.alert({
                        title: 'OOPS!',
                        content: 'An error occurred!',
                        theme: "modern"
                    })
                }
            })
        })

        // Auto Search
        var searchForm = $(".search-form")
        var searchInput = searchForm.find("[name='q']") // input name = 'q'
        var typingTimer;
        var searchBtn = searchForm.find("[type='submit']")
        // var typingInterval = 500 // 0.5 seconds
        searchInput.keyup(function (event) {
            // Keyup is for methods to be triggered when key is released
            clearTimeout(typingTimer)
            typingTimer = setTimeout(performSearch, 1000)
        })

        function displaySearching() {
            searchBtn.addClass("disabled")
            searchBtn.html("<i class='fa fa-spin fa-spinner'></i>Searching...")
        }

        function performSearch() {
            displaySearching()
            var query = searchInput.val();
            setTimeout(function () {
                window.location.href = '/search/?q=' + query;
            }, 1000)

        }

        // Cart + Add Products
        var productForm = $(".form-product-ajax")
        productForm.submit(function (event) {
            event.preventDefault();
            //console.log('Form is not sending')
            var thisForm = $(this) //referrring to only the current form instance
            var actionEndpoint = thisForm.attr("data-endpoint");
            var httpMethod = thisForm.attr("method");
            var formData = thisForm.serialize();
            console.log(formData);
            // ajax call
            $.ajax({
                url: actionEndpoint,
                method: httpMethod,
                data: formData,
                success: function (data) {
                    var submitSpan = thisForm.find(".submit-span")
                    console.log("data");
                    console.log(data);

                    if (data.added) {

                        submitSpan.html("In Cart <button type='submit' class='btn btn-link'>Remove?</button>")

                    }
                    else {
                        submitSpan.html("<button type='submit' class='btn btn-success'>Add to cart</button>")
                    }
                    var navbarCount = $(".navbar-cart-count")
                    navbarCount.text(data.cartItemCount)
                    var currentPath = window.location.href
                    if (currentPath.indexOf("cart") != -1) {
                        refreshCart()
                    }

                },
                error: function (errorData) {
                    $.alert({
                        title: 'OOPS!',
                        content: 'An error occurred!',
                        theme: "modern"
                    })

                }
            })


        })

        function refreshCart() {

            // this is some function

            console.log("In currentPathnt cart")
            var cartTable = $(".cart-table")
            var cartBody = cartTable.find(".cart-body")
            // cartBody.html("<h1>Changed</h1>")
            var productRows = cartBody.find(".cart-product")
            var currenUrl = window.location.href


            var refreshCartUrl = '/api/cart/';
            var refreshCartMethod = "GET";
            var data = {};


            $.ajax({
                url: refreshCartUrl,
                method: refreshCartMethod,
                data: data,
                success: function (data) {
                    // console.log("success");
                    // console.log(data);
                    var hiddenCartItemRemoveForm = $(".cart-item-remove-form")
                    if (data.products.length > 0) {
                        productRows.html("")
                        var i = data.products.length;
                        $.each(data.products, function (index, value) {
                            console.log(value)
                            var newCartItemRemove = hiddenCartItemRemoveForm.clone();
                            newCartItemRemove.css("display", "block");
                            // newCartItemRemove.removeClass("hidden-class")
                            newCartItemRemove.find('.cart-item-product-id').val(value.id)

                            cartBody.prepend("<tr><th scope=\"row\">" + i + "</th><td><a href='" + value.url + "'>" + value.name + "</a>" +
                                newCartItemRemove.html() + "</td><td>" + value.price + "</td>" + "</td></tr>")
                            --i;
                        })

                        cartBody.find(".cart-subtotal").text(data.subtotal)
                        cartBody.find(".cart-total").text(data.total)
                    } else {
                        // Refreshing the page by setting the same url
                        window.location.href = currenUrl
                    }
                },
                error: function (errorData) {
                    $.alert({
                        title: 'OOPS!',
                        content: 'An error occurred!'
                    })

                },
            })


        }
    });

</script>

</body>

</html>

