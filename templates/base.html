
<!DOCTYPE html>
<html>

	<head>
		<title></title>
		{# jquery #}
		{# slim is missing ajax and we need ajax #}
		<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ"
											  crossorigin="anonymous"></script> {# bootstrap #}
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4"
													 crossorigin="anonymous">
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm"
										       crossorigin="anonymous"></script>
		{# font awesome #}
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous"></head>

	<body>
		{% include "base/nav.html" with brand_name='eCommerce' %}
		<div class="container">
			{% block content %} {% endblock content %}

		</div>

		<script type="text/javascript">
			$(document).ready(function(){

				var productForm = $(".form-product-ajax")
				productForm.submit(function(event){
					event.preventDefault();
					//console.log('Form is not sending')
					var thisForm = $(this) //referrring to only the current form	
					var actionEndpoint = thisForm.attr("data-endpoint");
					var httpMethod = thisForm.attr("method");
					var formData = thisForm.serialize();
					console.log(formData);
					// ajax call
					$.ajax({
						url: actionEndpoint,
						method: httpMethod,
						data: formData,
						success: function(data){
							var submitSpan = thisForm.find(".submit-span")

							if(data.added){

								submitSpan.html("<button type='submit' class='btn btn-link'>Remove?</button>")

							}
							else{
								submitSpan.html("<button type='submit' class='btn btn-success'>Add to cart</button>")
							}
							var navbarCount = $(".navbar-cart-count")
							navbarCount.text(data.cartItemCount)
							var currentPath = window.location.href
							if(currentPath.indexOf("cart")!=-1){
								refreshCart()
							}

						},
						error:function(errorData){
							console.log("Error");
							console.log(errorData)

						}
					})


				})

				function refreshCart(){

					// this is some function

					console.log("In currentPathnt cart")
					var cartTable = $(".cart-table")
					var cartBody = cartTable.find(".cart-body")
					// cartBody.html("<h1>Changed</h1>")
					var productRows = cartBody.find(".cart-products")
					var currenUrl = window.location.href


					var refreshCartUrl = '/api/cart/';
					var refreshCartMethod = "GET";
					var data = {};


					$.ajax({
						url:refreshCartUrl,
						method:refreshCartMethod,
						data: data,
						success: function(data){
							console.log("success");
							console.log(data);
							if(data.products.length > 0){
							productRows.html("<tr><td colspan=3>Coming Soon</td></tr>")
								}else{
									// Refreshing the page by setting the same url
									window.location.href = currenUrl
									cartBody.find(".cart-subtotal").text(data.subtotal)
									cartBody.find(".cart-total").text(data.total)
								}
						},
						error: function(errorData){
							console.log("Error");
							console.log(errorData);

						},
					})





				}
			});

		</script>

	</body>

</html>

